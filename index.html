<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile app</title>
    <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
    <div id="root">
     
    </div>

    <script type="module" src="app.js"></script>

<script nomodule>
  // live-server 가 익스플로러 9 버전 이하는 지원하지 않아 현재 코드는 10, 11에서만 동작함
  var loadedPictureData = "";
  var userInfoData = {};

  // helper
  function setProperties(el, attrs){
    // 익스플로러 9 버전 미만은 Object.keys 지원 안한다
    if (!Object.keys) {
      Object.keys = function(obj) {
        var keys = [];

        for (var i in obj) {
          if (obj.hasOwnProperty(i)) {
            keys.push(i);
          }
        }

        return keys;
      };
    }
    if(attrs === undefined || attrs === null || Object.keys(attrs).length === 0) return;
    for(var attr in attrs){
      if(attr in el){
        el[attr] = attrs[attr];
      }else{
        el.setAttribute(attr, attrs[attr]); // 비호환 속성인지 체크해서 비호환 속성이면 setAttribute 으로 처리하기 (예 : data-url)
      }
    }
  }
  function setContents(el, contents){
    // forEach 가 존재하지 않는 경우
    if (!Array.prototype.forEach) {
        Array.prototype.forEach = function(fn, scope) {
            for(var i = 0, len = this.length; i < len; ++i) {
                fn.call(scope, this[i], i, this);
            }
        }
    }
    if(contents === undefined || contents === null || contents.length === 0) return;
    contents.forEach(function(content){
      // console.log(content, content instanceof Node)
      if(content instanceof Element){
        el.appendChild(content);
      }else{
        el.innerText = content;
      }
    })
  }

  function buildElement(type, attrs, contents){
    var el = document.createElement(type);
    setProperties(el, attrs);
    setContents(el, contents);
    return el;
  }
  function updateElement(id, attrs, contents){
    var el = document.getElementById(id);
    if(el === null){ // 검색한 DOM이 존재하지 않는 경우
      throw "Can't search dom element !";
    } 
    setProperties(el, attrs);
    setContents(el, contents);
    return el;
  }

  // 익스플로러 9버전 이하에서 호환하기 위한 이벤트핸들러 연결방법
  function addEvent(obj, type, handler){
    if(obj && obj.addEventListener){
      obj.addEventListener(type, handler);
    }else if(obj && obj.attachEvent){
      obj.attachEvent('on'+type, handler);
    }
  }

  function checkIfStringHasSpecialCharacter(str){
    var re = /[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/;
    return re.test(str);
  }
  function checkIfStringHasNumbers(str){
    return /\d/.test(str); 
  }
  function checkIfStringIsOnlyNumbers(str){
    return /^\d+$/.test(str);
  }
  function checkIfNumberIsInteger(num){
    return num % 1 === 0;
  }
  function checkIfAgeIsValid(str){
    var age = Number(str);
    if(!checkIfNumberIsInteger(age)) return; // check already on checkIfStringIsOnlyNumbers function (useless code)
    if(age < 1 || age > 150) return;
    return true;
  }
  function checkIfGenderIsValid(str){
    if(str !== "male" && str !== "female") return;
    return true;
  }
  function validateUserInfo(userName, userAge, userGender){

    if(userName === "" || checkIfStringHasSpecialCharacter(userName) || checkIfStringHasNumbers(userName)){
      return;
    }
    if(userAge === "" || !checkIfStringIsOnlyNumbers(userAge) || !checkIfAgeIsValid(userAge)){
      return;
    }
    if(userGender === "" || !checkIfGenderIsValid(userGender)){
      return;
    }
    return true;
  }
  function validateInputData(userName, userAge, userGender){
    if(!validateUserInfo(userName, userAge, userGender)) return;
    return true;
  }
  function validateFileExtension(fileData){
    var fileType = fileData.type;
    var ext = fileType.split("/")[0];
    if(ext !== "image") return;
    return true;
  }
  function loadPictureData(fileData){
    var reader = new FileReader(); 
    reader.onload=function(e){
      console.log('loaded profile picture!'); 
      loadedPictureData = e.target.result;
      // console.log(loadedPictureData)
    }; 
    reader.readAsDataURL(fileData);
  }
  function showModal(){
    updateElement('profile-modal', {'className': 'profile-modal show-modal'});
  }
  function hideModal(){
    updateElement('profile-modal', {'className': 'profile-modal'});
  }
  function clearModal(){
    loadedPictureData = "";
    document.getElementById('modal-info-name').value=''; 
    document.getElementById('modal-info-age').value=''; 
    document.getElementById('modal-info-gender').value=''; 
    document.getElementById('modal-filename').innerText='No file selected';
  }
  function setProfilePicture(){
    var profileImg = document.getElementById('card-picture').firstElementChild;
    profileImg.src=loadedPictureData; 
    profileImg.classList.add('show-profileImg');
  }
  function setProfileName(userName){
    document.getElementById('card-name').innerText = userName; 
  }
  function setUploadedFileName(fileData){
    document.getElementById('modal-filename').innerText=fileData.name; 
  }
  function saveUserInfo(userName, userAge, userGender){
    userInfoData.userName = userName;
    userInfoData.userAge = userAge;
    userInfoData.userGender = userGender;
  }
// Define Event handlers
  function hideProfileImg(event){
    updateElement(event.target.id, {'className': 'card-picture-img'});
  }
  function clearFileCash(event){ // 익스플로러 10에서는 동작하지 않음
    console.log(event.target);
    event.target.value = null;
  }
  function handleProfileSubmit(){
    showModal();
  }
  function handleModalCancel(){
    clearModal();
    hideModal();
  }
  function handlePictureSelect(){
    document.getElementById('modal-file').click()
  }
  function handlePictureUpload(event){ // 파일 취소시 해당 이벤트로 들어오지 않음
    // 파일 존재여부 검사
    var selectedFiles = event.target.files;
    if(selectedFiles.length < 1) return;

    // 파일 확장자 유효성 검사
    if(!validateFileExtension(selectedFiles[0])){
      alert("uploaded files is not valid");
      return;
    } 
    setUploadedFileName(selectedFiles[0]);
    loadPictureData(selectedFiles[0])
  }
  function handleModalSave(){
    var userName = document.getElementById('modal-info-name').value.trim();
    var userAge = document.getElementById('modal-info-age').value.trim();
    var userGender = document.getElementById('modal-info-gender').value.trim();

    // 입력 데이터 검증
    if(!validateInputData(userName, userAge, userGender)){
      alert("user information is not valid :(");
    }else{
      saveUserInfo(userName, userAge, userGender); // 프로필 정보 페이지에서 사용할 데이터 저장
      setProfileName(userName);
      setProfilePicture();
      clearModal();
      hideModal();
      console.log(userInfoData)
    }
  }
  function handleEnterKeyPress(event){
    // var charCode = event.charCode || event.keyCode || event.which;
    if(event.keyCode === 13){
      handleModalSave();
    }
  }

  // Home 페이지 생성
  var homePage = buildElement('div', {'id': 'profile-home'}, [
      buildElement('div', {'id': 'profile-main'}, [
        buildElement('div', {'id': 'profile-nav'}),
        buildElement('div', {'id': 'profile-card'}, [
          buildElement('div', {'id': 'profile-card-container'}, [
            buildElement('button', {'id': 'profile-submit'}, ['submit profile'])
          ])
        ])
      ]),
      buildElement('div', {'id': 'profile-modal', 'class': 'profile-modal'})
    ]);

    document.getElementById('root').appendChild(homePage);

  // 컴포넌트 생성

  // Nav 생성
  var navComponent = buildElement('div', {'id':'nav-component'}, [
    buildElement('button', {'class': 'nav-btns', 'data-url':'/'}, ['Home']),
    buildElement('button', {'class': 'nav-btns', 'data-url':'/about'}, ['About'])
  ]);

  document.getElementById('profile-nav').appendChild(navComponent);

  // Card 생성
  var cardComponent = buildElement('div', {'id': 'card-component'}, [
    buildElement('div', {'id': 'card-picture'}, [
      buildElement('img', {'id': 'card-picture-img', 'class': 'card-picture-img', 'src': '', 'alt': ''})
    ]),
    buildElement('div', {'id': 'card-name'})
  ]);

  var profileCardContainer = document.getElementById('profile-card-container');
  profileCardContainer.insertBefore(cardComponent, profileCardContainer.firstChild);

  // Modal 생성
  var modalComponent = buildElement('div', {'id': 'modal-component'}, [
    buildElement('div', {'id': 'modal-header'}, [
      'Select profile picture & save your info.',
      buildElement('button', {'id': 'modal-cancel', 'class': 'modal-cancel'}, ['X'])
    ]),
    buildElement('div', {'id': 'modal-contents'}, [
      buildElement('div', {'id': 'modal-filezone'}, [
        buildElement('input', {'id': 'modal-file', 'type': 'file', 'accept': 'image/*'}),
        buildElement('button', {'id': 'modal-select'}, ['Select picture']),
        buildElement('div', {'id': 'modal-filename'}, ['No file selected'])
      ]),
      buildElement('div', {'id': 'modal-info'}, [
        buildElement('input', {'type': 'text', 'id': 'modal-info-name', 'class': 'modal-info-inputs', 'placeholder': 'YOUR NAME'}),
        buildElement('input', {'type': 'text', 'id': 'modal-info-age', 'class': 'modal-info-inputs', 'placeholder': 'YOUR AGE'}),
        buildElement('input', {'type': 'text', 'id': 'modal-info-gender', 'class': 'modal-info-inputs', 'placeholder': 'YOUR GENDER'})
      ])
    ]),
    buildElement('div', {'id': 'modal-footer'}, [
      buildElement('button', {'id': 'modal-save'}, ['Save profile'])
    ])
  ]);

  var profileModal = document.getElementById('profile-modal');
  profileModal.appendChild(modalComponent);


  // 익스플로러 9버전 이하에서도 동작하기 위한 핸들러 연결방법
  addEvent(document.getElementById('card-picture').firstElementChild, 'error', hideProfileImg);
  addEvent(document.getElementById('profile-submit'), 'click', handleProfileSubmit);
  addEvent(document.getElementById('modal-cancel'), 'click', handleModalCancel);
  addEvent(document.getElementById('modal-file'), 'click', clearFileCash);
  addEvent(document.getElementById('modal-file'), 'change', handlePictureUpload);
  addEvent(document.getElementById('modal-select'), 'click', handlePictureSelect);
  addEvent(document.getElementById('modal-save'), 'click', handleModalSave);
  addEvent(document.getElementById("modal-info-gender"), 'keypress', handleEnterKeyPress);
</script>
  </body>
</html>
