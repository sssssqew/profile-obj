<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile app</title>
    <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
    <div id="root">
      <div id="profile-home">
        <div id="profile-main">
          <div id="profile-nav">
            
          </div>

          <div id="profile-card">
            <div id="profile-card-container">
            
              <button id="profile-submit">
                submit profile
              </button>
            </div>
          </div>
        </div>

        <div id="profile-modal" class="profile-modal">
          
        </div>
      </div>
    </div>

    <script type="module" src="app.js"></script>

<script nomodule>
  // live-server 가 익스플로러 9 버전 이하는 지원하지 않아 현재 코드는 10, 11에서만 동작함
  var loadedPictureData = "";
  var userInfoData = {};

  // helper
  function buildElement(type, props){
    var el = document.createElement(type);

    for(var prop in props){
      el.setAttribute(prop, props[prop]);
    }
    return el;
  }

  // 익스플로러 9버전 이하에서 호환하기 위한 이벤트핸들러 연결방법
  function addEvent(obj, type, handler){
    if(obj && obj.addEventListener){
      obj.addEventListener(type, handler);
    }else if(obj && obj.attachEvent){
      obj.attachEvent('on'+type, handler);
    }
  }

  function checkIfStringHasSpecialCharacter(str){
    var re = /[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/;
    return re.test(str);
  }
  function checkIfStringHasNumbers(str){
    return /\d/.test(str); 
  }
  function checkIfStringIsOnlyNumbers(str){
    return /^\d+$/.test(str);
  }
  function checkIfNumberIsInteger(num){
    return num % 1 === 0;
  }
  function checkIfAgeIsValid(str){
    var age = Number(str);
    if(!checkIfNumberIsInteger(age)) return; // check already on checkIfStringIsOnlyNumbers function (useless code)
    if(age < 1 || age > 150) return;
    return true;
  }
  function checkIfGenderIsValid(str){
    if(str !== "male" && str !== "female") return;
    return true;
  }
  function validateUserInfo(userName, userAge, userGender){

    if(userName === "" || checkIfStringHasSpecialCharacter(userName) || checkIfStringHasNumbers(userName)){
      return;
    }
    if(userAge === "" || !checkIfStringIsOnlyNumbers(userAge) || !checkIfAgeIsValid(userAge)){
      return;
    }
    if(userGender === "" || !checkIfGenderIsValid(userGender)){
      return;
    }
    return true;
  }
  function validateInputData(userName, userAge, userGender){
    if(!validateUserInfo(userName, userAge, userGender)) return;
    return true;
  }
  function validateFileExtension(fileData){
    var fileType = fileData.type;
    var ext = fileType.split("/")[0];
    if(ext !== "image") return;
    return true;
  }
  function loadPictureData(fileData){
    var reader = new FileReader(); 
    reader.onload=function(e){
      console.log('loaded profile picture!'); 
      loadedPictureData = e.target.result;
      // console.log(loadedPictureData)
    }; 
    reader.readAsDataURL(fileData);
  }
  function showModal(){
    document.getElementById('profile-modal').classList.add('show-modal');
  }
  function hideModal(){
    document.getElementById('profile-modal').classList.remove('show-modal');
  }
  function clearModal(){
    loadedPictureData = "";
    document.getElementById('modal-info-name').value=''; 
    document.getElementById('modal-info-age').value=''; 
    document.getElementById('modal-info-gender').value=''; 
    document.getElementById('modal-filename').innerText='No file selected';
  }
  function setProfilePicture(){
    var profileImg = document.getElementById('card-picture').firstElementChild;
    profileImg.src=loadedPictureData; 
    profileImg.classList.add('show-profileImg');
  }
  function setProfileName(userName){
    document.getElementById('card-name').innerText = userName; 
  }
  function setUploadedFileName(fileData){
    document.getElementById('modal-filename').innerText=fileData.name; 
  }
  function saveUserInfo(userName, userAge, userGender){
    userInfoData.userName = userName;
    userInfoData.userAge = userAge;
    userInfoData.userGender = userGender;
  }
// Define Event handlers
  function hideProfileImg(event){
    event.target.classList.remove("show-profileImg");
  }
  function clearFileCash(event){ // 익스플로러 10에서는 동작하지 않음
    console.log(event.target);
    event.target.value = null;
  }
  function handleProfileSubmit(){
    showModal();
  }
  function handleModalCancel(){
    clearModal();
    hideModal();
  }
  function handlePictureSelect(){
    document.getElementById('modal-file').click()
  }
  function handlePictureUpload(event){ // 파일 취소시 해당 이벤트로 들어오지 않음
    // 파일 존재여부 검사
    var selectedFiles = event.target.files;
    if(selectedFiles.length < 1) return;

    // 파일 확장자 유효성 검사
    if(!validateFileExtension(selectedFiles[0])){
      alert("uploaded files is not valid");
      return;
    } 
    setUploadedFileName(selectedFiles[0]);
    loadPictureData(selectedFiles[0])
  }
  function handleModalSave(){
    var userName = document.getElementById('modal-info-name').value.trim();
    var userAge = document.getElementById('modal-info-age').value.trim();
    var userGender = document.getElementById('modal-info-gender').value.trim();

    // 입력 데이터 검증
    if(!validateInputData(userName, userAge, userGender)){
      alert("user information is not valid :(");
    }else{
      saveUserInfo(userName, userAge, userGender); // 프로필 정보 페이지에서 사용할 데이터 저장
      setProfileName(userName);
      setProfilePicture();
      clearModal();
      hideModal();
      console.log(userInfoData)
    }
  }

  // TODO: 컴포넌트 생성

  // Nav 생성
  var homeNavBtn = buildElement('button', {'class': 'nav-btns', 'data-url':'/'});
  homeNavBtn.innerText = 'Home';
  var aboutNavBtn = buildElement('button', {'class': 'nav-btns', 'data-url':'/about'});
  aboutNavBtn.innerText = 'About';
  var navComponent = buildElement('div', {'id':'nav-component'});
  navComponent.appendChild(homeNavBtn);
  navComponent.appendChild(aboutNavBtn);

  document.getElementById('profile-nav').appendChild(navComponent);

  // Card 생성
  var cardPictureImg = buildElement('img', {'class': 'card-picture-img', 'src': '', 'alt': ''})
  var cardPicture = buildElement('div', {'id': 'card-picture'});
  cardPicture.appendChild(cardPictureImg);

  var cardName = buildElement('div', {'id': 'card-name'});
  var cardComponent = buildElement('div', {'id': 'card-component'});
  cardComponent.appendChild(cardPicture);
  cardComponent.appendChild(cardName);

  var profileCardContainer = document.getElementById('profile-card-container');
  profileCardContainer.insertBefore(cardComponent, profileCardContainer.firstChild);

  // Modal 생성
  
  // 모달 헤더
  var modalCancel = buildElement('button', {'id': 'modal-cancel', 'class': 'modal-cancel'});
  modalCancel.innerText = 'X';
  var modalHeader = buildElement('div', {'id': 'modal-header'});
  modalHeader.innerText = 'Select profile picture & save your info.';
  modalHeader.appendChild(modalCancel);

  // 모달 컨텐츠 - 파일존
  var modalFile = buildElement('input', {'id': 'modal-file', 'type': 'file', 'accept': 'image/*'});
  var modalSelect = buildElement('button', {'id': 'modal-select'});
  modalSelect.innerText = 'Select picture';
  var modalFilename = buildElement('div', {'id': 'modal-filename'});
  modalFilename.innerText = 'No file selected';
  var modalFilezone = buildElement('div', {'id': 'modal-filezone'});
  modalFilezone.appendChild(modalFile);
  modalFilezone.appendChild(modalSelect);
  modalFilezone.appendChild(modalFilename);

  // 모달 컨텐츠 - 인포
  var modalInfoName = buildElement('input', {'type': 'text', 'id': 'modal-info-name', 'class': 'modal-info-inputs', 'placeholder': 'YOUR NAME'});
  var modalInfoAge = buildElement('input', {'type': 'text', 'id': 'modal-info-age', 'class': 'modal-info-inputs', 'placeholder': 'YOUR AGE'});
  var modalInfoGender = buildElement('input', {'type': 'text', 'id': 'modal-info-gender', 'class': 'modal-info-inputs', 'placeholder': 'YOUR GENDER'});
  var modalInfo = buildElement('div', {'id': 'modal-info'});
  modalInfo.appendChild(modalInfoName);
  modalInfo.appendChild(modalInfoAge);
  modalInfo.appendChild(modalInfoGender);
  var modalContents = buildElement('div', {'id': 'modal-contents'});

  modalContents.appendChild(modalFilezone);
  modalContents.appendChild(modalInfo);

  //모달 풋터
  var modalSave = buildElement('button', {'id': 'modal-save'});
  modalSave.innerText = 'Save profile';
  var modalFooter = buildElement('div', {'id': 'modal-footer'});
  modalFooter.appendChild(modalSave);

  var modalComponent = buildElement('div', {'id': 'modal-component'});
  modalComponent.appendChild(modalHeader);
  modalComponent.appendChild(modalContents);
  modalComponent.appendChild(modalFooter);
  
  var profileModal = document.getElementById('profile-modal');
  profileModal.appendChild(modalComponent);
  console.log(modalComponent);


  // 익스플로러 9버전 이하에서도 동작하기 위한 핸들러 연결방법
  addEvent(document.getElementById('card-picture').firstElementChild, 'error', hideProfileImg);
  addEvent(document.getElementById('profile-submit'), 'click', handleProfileSubmit);
  addEvent(document.getElementById('modal-cancel'), 'click', handleModalCancel);
  addEvent(document.getElementById('modal-file'), 'click', clearFileCash);
  addEvent(document.getElementById('modal-file'), 'change', handlePictureUpload);
  addEvent(document.getElementById('modal-select'), 'click', handlePictureSelect);
  addEvent(document.getElementById('modal-save'), 'click', handleModalSave);
</script>
  </body>
</html>
